Page({data:{menu:[],pageIndex:-1,member:!1,r:!1,show:"login",user:{token:wx.getStorageSync("token"),schoolId:wx.getStorageSync("schoolId"),mobile:"",password:"",btnstate:!0},forgetPage:{timeout:60,smsstate:!0,btnstate:!0,timer:null,smsbtn:"短信验证码"},registerPage:{timeout:60,smsstate:!0,btnstate:!0,timer:null,smsbtn:"短信验证码"},register:{token:wx.getStorageSync("token"),schoolId:wx.getStorageSync("schoolId"),mobile:"",smsCode:"",uuid:"",username:"",password:""},forget:{token:wx.getStorageSync("token"),mobile:"",smsCode:"",uuid:"",oldPwd:"",newPwd:"",type:0}},onLoad:function(e){e.r&&(this.data.r=e.r),wx.setNavigationBarTitle({title:"登录"}),this.checkRegisterConfig()},switchpassword:function(){},clearInput:function(e){let t=this,o=e.currentTarget,s=o.dataset.id;if(console.log(o.dataset),console.log("清除输入框"),s){let e={};e[s]=null,t.setData(e),console.log("清除输入框")}},getChange:function(e){let t=this,o=e.currentTarget.dataset.id,s=e.detail.value,a={},n=o.split("."),i=this.data.show,r={telphone:/^1[3,4,5,6,7,8]\d{9}$/,code:/^\d{4,6}$/,password:/^.{6,16}$/,user:/^\w{3,}$/};if(a[o]=s,this.setData(a),"forget"===i&&("mobile"===n[1]&&t.setData({"forgetPage.smsstate":!r.telphone.test(s)}),r.telphone.test(t.data.forget.mobile)&&r.code.test(t.data.forget.smsCode)&&r.password.test(t.data.forget.newPwd)&&t.data.forget.uuid&&t.setData({"forgetPage.btnstate":!1})),"register"===i){let e=!t.data.mobileFlag,o=!t.data.usernameFlag;t.data.mobileFlag&&("mobile"===n[1]&&t.setData({"registerPage.smsstate":!r.telphone.test(s)}),e=!!(r.code.test(t.data.register.smsCode)&&r.telphone.test(t.data.register.mobile)&&t.data.register.uuid)),t.data.usernameFlag&&(o=r.user.test(t.data.register.username)),e&&o&&r.password.test(t.data.register.password)&&t.setData({"registerPage.btnstate":!1})}if("login"===i){let e=this.data.user;t.setData({"user.btnstate":!(e.mobile.length>3&&e.password.length>5)})}},checklogin:function(){let e=this.data.user,t=this.data.user.btnstate;return console.log(e),console.log(t),!t&&(e.mobile.length<3||e.password.length<6?(wx.showToast({title:"用户名/密码输入不正确",icon:"none"}),!1):void this.loginMember())},changePage:function(e){let t=e.target.dataset.page,o="登录";if(t){switch(this.setData({show:t}),t){case"forget":o="找回密码";break;case"register":o="注册"}wx.setNavigationBarTitle({title:o})}},sendsms:function(e){let t=this,o=t.data.show,s="",a={token:wx.getStorageSync("token"),mobile:"",type:""},n={url:wx.getStorageSync("host")+"/user/sendSms",data:a,method:"POST",dataType:"json",success:function(e){if(wx.hideLoading(),200===e.statusCode){let s=e.data;if(console.log(s),s.flag)wx.showToast({title:s.msg,icon:"none"});else{console.log(o);let e={};e[o+".uuid"]=s.data.uuid,t.setData(e),function e(){let s,a="register"===o?"registerPage":"forgetPage",n=t.data[a].timeout,i=[".timer",".timeout",".smsbtn",".smsstate"],r=[],l={};if(--n){r=[s=setTimeout(e,1e3),n,n+"秒后重试",!0];for(let e in i)l[a+i[e]]=r[e],t.setData(l),l={}}else{r=[null,60,"发送验证码",!1];for(let e in i)l[a+i[e]]=r[e],t.setData(l),l={}}}()}}},fail:function(){},complete:function(){}};switch(o){case"register":s=t.data.register.mobile,a.type="regist";break;case"forget":s=t.data.forget.mobile,a.type="findPwd"}a.mobile=s,console.log("send sms",o,s),console.log(a),wx.getStorageSync("token")&&wx.request(n)},checkRegisterConfig:function(){let e=this,t={url:wx.getStorageSync("host")+"/user/registerConfig",data:{token:wx.getStorageSync("token")},method:"POST",dataType:"json",success:function(t){if(wx.hideLoading(),200===t.statusCode){let o=t.data,s=["closeFlag","mobileFlag","usernameFlag"],a={};console.log(o);for(let t in s)a[s[t]]=o.data[s[t]],e.setData(a)}},fail:function(){},complete:function(){}};wx.getStorageSync("token")&&wx.request(t)},loginMember:function(){let e=this,t={url:wx.getStorageSync("host")+"/user/login",data:e.data.user,method:"POST",dataType:"json",success:function(t){if(wx.hideLoading(),200===t.statusCode){let o=t.data,s=["name","username","stuId","userId","headPicMax","mobile","vipFlag","schoolId"];if(console.log(o),+o.flag)wx.showToast({title:o.msg,icon:"none",duration:3e3});else{console.log("登录成功"),wx.showToast({title:"登录成功",icon:"none"});for(let e in s)wx.setStorageSync(s[e],o.data[s[e]]);setTimeout(function(){wx.redirectTo({url:e.data.r||"/pages/user/index/index"})},800)}}},fail:function(){},complete:function(){}};wx.showLoading({title:"登录中..."}),wx.getStorageSync("token")&&wx.getStorageSync("schoolId")?wx.request(t):(wx.showToast({title:"获取信息失败",icon:"none"}),console.log("登录失败"))},registerMember:function(){let e=this,t={url:wx.getStorageSync("host")+"/user/register",data:e.data.register,method:"POST",dataType:"json",success:function(t){if(wx.hideLoading(),200===t.statusCode){let o=t.data,s=["register.mobile","register.smsCode","register.uuid","register.username","register.password"];e.setData({"user.mobile":e.data.register[e.data.mobileFlag?"mobile":"username"]}),e.setData({"user.password":e.data.register.password});for(let t in s){let o={};o[s[t]]="",e.setData(o)}+o.flag?wx.showToast({title:o.msg,icon:"none",duration:3e3}):(console.log("注册成功"),wx.showToast({title:"注册成功,跳转...",icon:"none"}),e.loginMember())}},fail:function(){},complete:function(){}};wx.showLoading({title:"注册中..."}),console.log(e.data.register),wx.getStorageSync("token")&&wx.getStorageSync("schoolId")?wx.request(t):(wx.showToast({title:"注册用户失败",icon:"none"}),console.log("注册失败"))},checkForget:function(){let e=this,t={url:wx.getStorageSync("host")+"/user/changePwd",data:e.data.forget,method:"POST",dataType:"json",success:function(t){if(wx.hideLoading(),200===t.statusCode){let o=t.data,s=["forget.mobile","forget.smsCode","forget.uuid","forget.newPwd"];for(let t in s){let o={};o[s[t]]="",e.setData(o)}o.flag?wx.showToast({title:"密码修改失败，请重试！",icon:"none"}):(wx.showToast({title:"密码修改成功，跳转登录...",icon:"none"}),setTimeout(function(){e.setData({show:"login"})},1500))}},fail:function(){},complete:function(){}};wx.getStorageSync("token")&&wx.request(t)}});