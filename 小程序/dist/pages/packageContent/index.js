const util=require("../../utils/md5.js"),WxParse=require("../../wxParse/wxParse.js"),polyv=require("../../utils/polyv.js");Page({data:{menu:wx.getStorageSync("menu")||[],pageIndex:-1,cover:"../../images/default_img.jpg",show:!1,currentTab:0,bannerheight:0,video:{},studyStatus:["","未学习","未完成","已学习"],freeFlag:["","免费","试听"],freeFlagStyle:["danger ","free","danger"],class_type:"live"},onLoad:function(e){if(console.log("-----------"),console.log(e),e.type&&this.setData({classType:e.type}),e.id){let t=this;this.setData({classId:e.id}),wx.showLoading({title:"",complete:function(){t.loadClassInfo(e.id),t.loadClassList(e.id)}})}else wx.showToast({title:"没有发现该课程",duration:3e3,complete:function(){console.log("success")}});wx.getStorageSync("screenWidth");this.setData({bannerheight:9*wx.getStorageSync("screenWidth")/16+"px"})},selectType:function(e){let t=e.target.dataset;this.setData({class_type:t.type})},loadClassInfo:function(e){let t=this,a={url:wx.getStorageSync("host")+"/course/queryCourseDetail",data:{token:wx.getStorageSync("token"),classTypeId:e},header:{},method:"POST",dataType:"json",success:function(e){if(wx.hideLoading(),200!==e.statusCode||+e.data.flag)wx.showToast({title:"课程加载失败"});else{let a=e.data.data;wx.setNavigationBarTitle({title:a.name}),t.setData({cover:a.cover,classsTitle:a.name,show:!0,detailDesc:a.detailDesc,buyNum:(+a.buyNum||0)+(+a.baseNum||0),courseHour:a.courseHour||0,realPrice:a.realPrice,yxq:a.yxq}),WxParse.wxParse("article","html",a.detailDesc,t,5)}},fail:function(){},complete:function(){}};wx.getStorageSync("token")&&e?wx.request(a):console.log("获取域名失败")},loadClassList:function(e){let t=this,a=wx.getStorageSync("host"),s={url:a,data:{token:wx.getStorageSync("token"),classTypeId:e,userid:wx.getStorageSync("userId")||""},header:{},method:"POST",dataType:"json",success:function(e){if(wx.hideLoading(),200!==e.statusCode||+e.data.flag)wx.showToast({title:"课程加载失败"});else{let a=e.data.data,s={};if("video"==t.data.classType||"remote"==t.data.classType)a.length&&(s={cc:a[0].cc,blvs:a[0].blvs,bjy:a[0].bjy}),t.setData({list:a,videoConfig:s});else{let e=[{chapterName:"今日课程",lectures:[]},{chapterName:"后续课程",lectures:[]},{chapterName:"历史课程",lectures:[]}];for(let t in a){let s=0;switch(a[t].dayStatus){case"tommorow":s=1;break;case"yestoday":s=2}e[s].lectures.push(a[t])}t.setData({list:e})}}},fail:function(){},complete:function(){}};console.log(t.data.classType),"video"==t.data.classType||"remote"==t.data.classType?a+="/course/queryCourseVideoList":a+="/course/queryCourseLiveAndFaceList",s.url=a,wx.getStorageSync("token")&&e?wx.request(s):console.log("获取域名失败")},changeTab:function(e){let t=e.target.dataset.index||0;this.setData({currentTab:t})},getVideo:function(e){let t=this,a=e.currentTarget.dataset,s=a.storage,o=a.vid,l=a.type,i=a.id,c=a.mid,n=a.live||!1,r=a.status||"",d=this.data.classId,u=wx.getStorageSync("userId"),g=wx.getStorageSync("token"),h={};if(console.log(i,d,u,l,c,n,s,o),!u)return wx.showToast({title:"您还没有登录",icon:"none"}),!1;switch(l){case"video":h.data={token:g,userId:u,moduleId:c,lectureId:i,classTypeId:d},h.url=wx.getStorageSync("host")+"/course/checkVideoPermission";break;case"live":h.data={token:g,classTypeId:d,url:c,lessonId:i,status:r,userId:u},h.url=wx.getStorageSync("host")+"/course/checkLivePermission"}this.checkPermission(h,function(e){let a=e.statusCode,i=e.data;if(200==a){let e=i.data.flag;switch(console.log(i),l){case"video":+e?wx.showToast({title:i.data.reason||"没有权限查看该视频",icon:"none"}):t.playVideo({storage:s,vid:o});break;case"live":if(+e)wx.showToast({title:i.data.reason||"没有权限查看该视频",icon:"none"});else{wx.showToast({title:"状态正常",icon:"none"});let e={};switch(n){case"ht":case"zs":e={storage:"live",type:n,url:i.data.replayUrl,token:i.data.assessToken}}t.playVideo(e)}}}else wx.showToast({title:"出现错误，稍后重试",icon:"none"})})},checkPermission:function(e,t){let a=wx.getStorageSync("token"),s={url:e.url,data:e.data,header:{},method:"POST",dataType:"json",success:function(e){"function"==typeof t&&t(e)},fail:function(){},complete:function(){}};a?wx.request(s):console.log("获取域名失败")},playVideo:function(e){let t=this;switch(console.log(e),console.log("----"),t.setData({playid:null,video:{}}),e.storage){case"VIDEO_STORAGE_TYPE_BLVS":polyv.getVideo(e.vid,function(e){t.setData({playid:"polyvVideo",video:{src:e.src[0]}})});break;case"VIDEO_STORAGE_TYPE_CC":let a=t.data.videoConfig,s={userid:a.cc.ccUserId,videoid:e.vid,httpsflag:"1",hlsflag:"0",format:"json"},o={url:"https://union.bokecc.com/api/mobile",data:{},method:"GET",dataType:"json",success:function(e){let a={};200===e.statusCode?(a=e.data)?(a=a.video,console.log(a),t.setData({playid:"ccVideo",video:{src:a.copy[0].playurl}})):wx.showToast({title:"视频加载失败，请稍后再试",icon:"none"}):wx.showToast({title:"发生网络错误，请稍后再试",icon:"none"})},fail:function(){},complete:function(){}},l=Object.keys(s).sort(),i="",c="";for(let e in l)i+=l[e]+"="+s[l[e]]+"&";i+="time="+Math.floor((new Date).getTime()/1e3),i+="&hash="+(c=util.hexMD5(i+"&salt="+a.cc.ccApiKey).toUpperCase()),o.url+="?"+i,wx.request(o);break;case"VIDEO_STORAGE_TYPE_BJY":wx.showToast({title:"很抱歉，暂不支持播放该视频",icon:"none"});break;case"live":let n="/pages/playvideo/index",r=e.type,d=encodeURIComponent(e.url.replace("http://","https://")),u=e.token,g="";switch(console.log(r),r){case"ht":g=n+"?type="+r+"&url="+d+"&token="+u;break;default:g=n+"?type="+r+"&url="+d}console.log(g),console.log(d),wx.navigateTo({url:g});break;default:wx.showToast({title:"很抱歉，暂不支持播放该视频",icon:"none"})}}});